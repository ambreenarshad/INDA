---
- name: Create links in GNS3 project based on JSON file
  hosts: localhost
  gather_facts: no
  vars:
    gns3_server: "http://127.0.0.1:3080"
    project_name: "Final_Testing_2"
    
  tasks:
    - name: Get all projects from GNS3
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: GET
        return_content: yes
      register: gns3_projects

    - name: Set project ID based on project name
      set_fact:
        project_id: "{{ (gns3_projects.json | selectattr('name', 'equalto', project_name) | list)[0].project_id }}"
      when: gns3_projects.json | selectattr('name', 'equalto', project_name) | list | length > 0
      
    - name: Check if the project is opened
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}"
        method: GET
        return_content: yes
      register: project_status

    - name: Open the project if it is not already opened
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/open"
        method: POST
        return_content: yes
        status_code: [200, 201]
      when: project_status.json.status != "opened"
      
    - name: Retrieve device node IDs from the GNS3 project
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
        return_content: yes
      register: gns3_nodes
    
    - name: Create link from S5224F-ONFrontView33 to N3248TE-ONFrontView77
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5224F-ONFrontView33'] }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['N3248TE-ONFrontView77'] }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link from S5224F-ONFrontView33 to S5212F-ONFrontView(ACPower)66
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5224F-ONFrontView33'] }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)66'] }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link from S5224F-ONFrontView33 to S5224F-ONFrontView69
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5224F-ONFrontView33'] }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['S5224F-ONFrontView69'] }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link from S5224F-ONFrontView33 to S5232F-ONFrontView59
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5224F-ONFrontView33'] }}"
            adapter_number: 3
            port_number: 0
          - node_id: "{{ device_map['S5232F-ONFrontView59'] }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link from S4128F-ONFrontView47 to N3248TE-ONFrontView77
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S4128F-ONFrontView47'] }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['N3248TE-ONFrontView77'] }}"
            adapter_number: 1
            port_number: 0
        
    - name: Create link from S4128F-ONFrontView47 to S5212F-ONFrontView(ACPower)66
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S4128F-ONFrontView47'] }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)66'] }}"
            adapter_number: 1
            port_number: 0
        
    - name: Create link from S4128F-ONFrontView47 to S5224F-ONFrontView69
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S4128F-ONFrontView47'] }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['S5224F-ONFrontView69'] }}"
            adapter_number: 1
            port_number: 0
        
    - name: Create link from S4128F-ONFrontView47 to S5232F-ONFrontView59
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S4128F-ONFrontView47'] }}"
            adapter_number: 3
            port_number: 0
          - node_id: "{{ device_map['S5232F-ONFrontView59'] }}"
            adapter_number: 1
            port_number: 0
        
    - name: Create link from S5212F-ONFrontView(ACPower)30 to N3248TE-ONFrontView77
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)30'] }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['N3248TE-ONFrontView77'] }}"
            adapter_number: 2
            port_number: 0
        
    - name: Create link from S5212F-ONFrontView(ACPower)30 to S5212F-ONFrontView(ACPower)66
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)30'] }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)66'] }}"
            adapter_number: 2
            port_number: 0
        
    - name: Create link from S5212F-ONFrontView(ACPower)30 to S5224F-ONFrontView69
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)30'] }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['S5224F-ONFrontView69'] }}"
            adapter_number: 2
            port_number: 0
        
    - name: Create link from S5212F-ONFrontView(ACPower)30 to S5232F-ONFrontView59
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)30'] }}"
            adapter_number: 3
            port_number: 0
          - node_id: "{{ device_map['S5232F-ONFrontView59'] }}"
            adapter_number: 2
            port_number: 0
        
    - name: Create link from N3248TE-ONFrontView41 to S5232F-ONFrontView59
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['N3248TE-ONFrontView41'] }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['S5232F-ONFrontView59'] }}"
            adapter_number: 3
            port_number: 0
        
    - name: Create link from N3248TE-ONFrontView41 to S5224F-ONFrontView69
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['N3248TE-ONFrontView41'] }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['S5224F-ONFrontView69'] }}"
            adapter_number: 3
            port_number: 0
        
    - name: Create link from N3248TE-ONFrontView41 to S5212F-ONFrontView(ACPower)66
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['N3248TE-ONFrontView41'] }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['S5212F-ONFrontView(ACPower)66'] }}"
            adapter_number: 3
            port_number: 0
        
    - name: Create link from N3248TE-ONFrontView41 to N3248TE-ONFrontView77
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['N3248TE-ONFrontView41'] }}"
            adapter_number: 3
            port_number: 0
          - node_id: "{{ device_map['N3248TE-ONFrontView77'] }}"
            adapter_number: 3
            port_number: 0
        