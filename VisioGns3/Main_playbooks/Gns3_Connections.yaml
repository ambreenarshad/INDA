---
- name: Create links in GNS3 project based on JSON file
  hosts: localhost
  gather_facts: no
  vars:
    gns3_server: "http://127.0.0.1:3080"
    project_name: "first.drawio"
    
  tasks:
    - name: Get all projects from GNS3
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: GET
        return_content: yes
      register: gns3_projects

    - name: Set project ID based on project name
      set_fact:
        project_id: "{{ (gns3_projects.json | selectattr('name', 'equalto', project_name) | list)[0].project_id }}"
      when: gns3_projects.json | selectattr('name', 'equalto', project_name) | list | length > 0
      
    - name: Check if the project is opened
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}"
        method: GET
        return_content: yes
      register: project_status

    - name: Open the project if it is not already opened
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/open"
        method: POST
        return_content: yes
        status_code: [200, 201]
      when: project_status.json.status != "opened"
      
    - name: Retrieve device node IDs from the GNS3 project
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
        return_content: yes
      register: gns3_nodes
    
    - name: Create link atm_router to atm_fast_gigabit_etherswitch-3
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router'] | default('') }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-3'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch-2 to terminal-2
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-2'] | default('') }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['terminal-2'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_router-2 to atm_fast_gigabit_etherswitch-5
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router-2'] | default('') }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-5'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch-5 to terminal-5
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-5'] | default('') }}"
            adapter_number: 0
            port_number: 1
          - node_id: "{{ device_map['terminal-5'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_router to atm_fast_gigabit_etherswitch
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router'] | default('') }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_router to atm_fast_gigabit_etherswitch-2
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router'] | default('') }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-2'] | default('') }}"
            adapter_number: 0
            port_number: 1
        
    - name: Create link atm_router-2 to atm_fast_gigabit_etherswitch-4
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router-2'] | default('') }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-4'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_router-2 to atm_fast_gigabit_etherswitch-6
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router-2'] | default('') }}"
            adapter_number: 2
            port_number: 0
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-6'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_router-3 to atm_router
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router-3'] | default('') }}"
            adapter_number: 0
            port_number: 0
          - node_id: "{{ device_map['atm_router'] | default('') }}"
            adapter_number: 3
            port_number: 0
        
    - name: Create link atm_router-3 to atm_router-2
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_router-3'] | default('') }}"
            adapter_number: 1
            port_number: 0
          - node_id: "{{ device_map['atm_router-2'] | default('') }}"
            adapter_number: 3
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch to terminal
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch'] | default('') }}"
            adapter_number: 0
            port_number: 1
          - node_id: "{{ device_map['terminal'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch-3 to terminal-3
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-3'] | default('') }}"
            adapter_number: 0
            port_number: 1
          - node_id: "{{ device_map['terminal-3'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch-4 to terminal-4
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-4'] | default('') }}"
            adapter_number: 0
            port_number: 1
          - node_id: "{{ device_map['terminal-4'] | default('') }}"
            adapter_number: 0
            port_number: 0
        
    - name: Create link atm_fast_gigabit_etherswitch-6 to terminal-6
      vars:
        device_map: "{{ gns3_nodes.json | items2dict(key_name='name', value_name='node_id') }}"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json
        status_code: [200, 201]
        body:
          nodes:
          - node_id: "{{ device_map['atm_fast_gigabit_etherswitch-6'] | default('') }}"
            adapter_number: 0
            port_number: 1
          - node_id: "{{ device_map['terminal-6'] | default('') }}"
            adapter_number: 0
            port_number: 0
        